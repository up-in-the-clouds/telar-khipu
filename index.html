---
layout: default
title: Home
---

<div class="container my-5">
  <div class="row">
    <div class="col-lg-11 mx-auto">
      {% assign logo_path = site.logo | strip %}
      {% if logo_path != "" %}
      <img src="{{ logo_path | relative_url }}" alt="{{ site.title }}" class="mb-4" style="max-width: 200px;">
      {% endif %}

      <h1 class="display-4 mb-3">{{ site.telar.project_title | default: site.title }}</h1>

      {% if site.telar.tagline %}
      <p class="lead mb-5">{{ site.telar.tagline }}</p>
      {% endif %}
    </div>
  </div>

  {% if site.description %}
  <div class="row">
    <div class="col-lg-11 mx-auto">
      <p class="lead mb-5">{{ site.description }}</p>
    </div>
  </div>
  {% endif %}

  <!-- Theme Validation -->
  {% assign has_theme_issue = false %}
  {% assign theme_error_type = "" %}
  {% assign configured_theme = site.data.themes[site.telar_theme] %}

  {% if configured_theme == nil or configured_theme == empty %}
    {% assign has_theme_issue = true %}

    {%- comment -%}Check if theme exists in _data/themes folder but failed to load{%- endcomment -%}
    {% assign all_theme_files = site.static_files | where_exp: "file", "file.path contains '_data/themes'" | where_exp: "file", "file.extname == '.yml'" %}
    {% assign theme_file_exists = false %}
    {% for file in all_theme_files %}
      {% if file.path contains site.telar_theme %}
        {% assign theme_file_exists = true %}
      {% endif %}
    {% endfor %}

    {% if theme_file_exists %}
      {% assign theme_error_type = "malformed" %}
    {% elsif site.data.themes['paisajes'] %}
      {% assign theme_error_type = "not_found" %}
    {% else %}
      {% assign theme_error_type = "critical" %}
    {% endif %}
  {% elsif configured_theme.colors == nil or configured_theme.fonts == nil %}
    {%- comment -%}Theme exists but missing required sections{%- endcomment -%}
    {% assign has_theme_issue = true %}
    {% assign theme_error_type = "malformed" %}
  {% endif %}

  <!-- Configuration Issues Warning -->
  {% assign has_object_issues = false %}
  {% assign stories_with_issues = "" | split: "" %}

  {%- comment -%}Check for object warnings{%- endcomment -%}
  {% for object in site.objects %}
    {% if object.object_warning and object.object_warning != "" %}
      {% assign has_object_issues = true %}
      {% break %}
    {% endif %}
  {% endfor %}

  {%- comment -%}Collect stories with warnings{%- endcomment -%}
  {% for story in site.stories %}
    {% assign story_data = site.data[story.data_file] %}
    {% if story_data.size > 0 and story_data[0]._metadata %}
      {% assign metadata = story_data[0] %}
      {% if metadata.viewer_warnings.size > 0 %}
        {% assign stories_with_issues = stories_with_issues | push: story %}
      {% endif %}
    {% endif %}
  {% endfor %}

  {% if has_theme_issue or has_object_issues or stories_with_issues.size > 0 %}
  <div class="row">
    <div class="col-lg-11 mx-auto">
      <div class="alert alert-warning" role="alert" style="max-width: 800px;">
        <strong>⚠️ Configuration Issues Detected</strong>
        <p class="mb-0 mt-2"><small>
          {% if has_theme_issue %}
            {% if theme_error_type == "not_found" %}
              The theme '{{ site.telar_theme }}' doesn't exist. We've applied the 'paisajes' (default) theme instead. To choose a different theme, update telar_theme in _config.yml to one of: paisajes, neogranadina, santa-barbara, or austin. If you are trying to add a custom theme and you don't see it listed in this message, check it is in the `_data/themes` folder.
            {% elsif theme_error_type == "malformed" %}
              The theme '{{ site.telar_theme }}' file appears to be broken or incomplete. We've applied the 'paisajes' (default) theme instead. Check _data/themes/{{ site.telar_theme }}.yml for syntax errors or compare it to a working theme file.
            {% elsif theme_error_type == "critical" %}
              We encountered a problem loading themes. The _data/themes folder may be missing or damaged. The site is currently using basic default styling. Please check that your _data/themes folder contains valid theme files, or restore it from your repository.
            {% endif %}
            <br><br>
          {% endif %}
          {% if has_object_issues and stories_with_issues.size > 0 %}
            {% assign second_to_last = stories_with_issues.size | minus: 1 %}
            Some objects and stories have configuration issues. Navigate to the <a href="{{ '/objects/' | relative_url }}" class="alert-link">objects page</a> or
            {% for story in stories_with_issues %}
              <a href="{{ story.url | relative_url }}" class="alert-link">{{ story.title }}</a>{% unless forloop.last %}{% if forloop.index == second_to_last %} or {% else %}, {% endif %}{% endunless %}
            {% endfor %} to see more details.
          {% elsif has_object_issues %}
            Some objects have configuration issues. Navigate to the <a href="{{ '/objects/' | relative_url }}" class="alert-link">objects page</a> to see more details.
          {% elsif stories_with_issues.size > 0 %}
            {% assign second_to_last = stories_with_issues.size | minus: 1 %}
            Some stories have configuration issues. Navigate to
            {% for story in stories_with_issues %}
              <a href="{{ story.url | relative_url }}" class="alert-link">{{ story.title }}</a>{% unless forloop.last %}{% if forloop.index == second_to_last %} or {% else %}, {% endif %}{% endunless %}
            {% endfor %} to see more details.
          {% endif %}
        </small></p>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Stories List -->
  <div class="row">
    <div class="col-lg-11 mx-auto">
      <h2 class="mb-4">Explore the stories</h2>

      {% if site.stories.size > 0 %}
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-5">
        {% for story in site.stories %}
        <div class="col">
          <a href="{{ story.url | relative_url }}" class="story-card text-decoration-none">
            <div class="card h-100 border-0 shadow-sm">
              {%- comment -%}Load story data file and extract first object{%- endcomment -%}
              {% assign story_data = site.data[story.data_file] %}
              {% if story_data and story_data.size > 0 %}
                {% assign first_step = story_data[0] %}
                {% if first_step.object %}
                  {%- comment -%}Load thumbnail with object ID for remote/local detection{%- endcomment -%}
                  <div class="story-iiif-thumbnail card-img-top" data-object-id="{{ first_step.object }}" data-info-json="{{ '/iiif/objects/' | append: first_step.object | append: '/info.json' | relative_url }}" style="aspect-ratio: 1; overflow: hidden;">
                    <div class="manifest-thumbnail-placeholder bg-light d-flex align-items-center justify-content-center h-100">
                      <span class="text-muted">Loading...</span>
                    </div>
                  </div>
                {% else %}
                  {%- comment -%}Fallback placeholder if no object{%- endcomment -%}
                  <div class="story-thumbnail-placeholder bg-secondary d-flex align-items-center justify-content-center" style="aspect-ratio: 1;">
                    <span class="text-white">{{ story.story_number }}</span>
                  </div>
                {% endif %}
              {% else %}
                {%- comment -%}Fallback placeholder if no data file{%- endcomment -%}
                <div class="story-thumbnail-placeholder bg-secondary d-flex align-items-center justify-content-center" style="aspect-ratio: 1;">
                  <span class="text-white">{{ story.story_number }}</span>
                </div>
              {% endif %}

              <div class="card-body">
                <h3>{{ story.title }}</h3>
              </div>
            </div>
          </a>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="alert alert-info">
        <p class="mb-0">No stories available yet. Create story files in the <code>_stories/</code> directory to get started.</p>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Objects Teaser -->
  {% if site.objects.size > 0 %}
  <div class="row mt-5">
    <div class="col-lg-11 mx-auto">
      <h3 class="mb-4">See the objects behind the stories</h3>
      <p class="lead">Browse {{ site.objects.size }} objects featured in the stories.</p>
      <a href="{{ '/objects/' | relative_url }}" class="btn btn-primary">View Objects</a>
    </div>
  </div>
  {% endif %}
</div>

<script>
// Pass objects data for manifest lookup
window.objectsData = {{ site.data.objects | jsonify }};

/**
 * Load story thumbnails from IIIF (remote manifests or local info.json)
 */
document.addEventListener('DOMContentLoaded', function() {
  const storyThumbnails = document.querySelectorAll('.story-iiif-thumbnail[data-object-id]');

  storyThumbnails.forEach(function(item) {
    const objectId = item.getAttribute('data-object-id');
    const localInfoUrl = item.getAttribute('data-info-json');

    // Find object in objectsData
    const objectData = window.objectsData.find(obj => obj.object_id === objectId);

    // Check if object has remote IIIF manifest
    if (objectData && objectData.iiif_manifest) {
      // Remote manifest - fetch it and extract larger canvas image
      fetch(objectData.iiif_manifest)
        .then(response => response.json())
        .then(manifest => {
          let imageServiceUrl = null;
          let fallbackImageUrl = null;

          // IIIF Presentation API 2.1
          if (manifest.sequences && manifest.sequences[0] && manifest.sequences[0].canvases) {
            const firstCanvas = manifest.sequences[0].canvases[0];
            if (firstCanvas && firstCanvas.images && firstCanvas.images[0]) {
              const resource = firstCanvas.images[0].resource;

              // Try to get image service for resizing
              if (resource.service) {
                const service = Array.isArray(resource.service) ? resource.service[0] : resource.service;
                imageServiceUrl = service['@id'] || service.id;
              }

              // Fallback to full image URL
              if (!imageServiceUrl && resource['@id']) {
                fallbackImageUrl = resource['@id'];
              }
            }
          }
          // IIIF Presentation API 3.0
          else if (manifest.items && manifest.items[0]) {
            const firstCanvas = manifest.items[0];
            if (firstCanvas.items && firstCanvas.items[0] && firstCanvas.items[0].items) {
              const annotationBody = firstCanvas.items[0].items[0].body;

              // Try to get image service for resizing
              if (annotationBody.service && annotationBody.service.length > 0) {
                imageServiceUrl = annotationBody.service[0].id || annotationBody.service[0]['@id'];
              }

              // Fallback to full image URL
              if (!imageServiceUrl && annotationBody.id) {
                fallbackImageUrl = annotationBody.id;
              }
            }
          }

          let thumbnailUrl = null;

          // If we have an image service, request a 400px thumbnail
          if (imageServiceUrl) {
            // Remove trailing slash if present
            imageServiceUrl = imageServiceUrl.replace(/\/$/, '');
            thumbnailUrl = `${imageServiceUrl}/full/!400,400/0/default.jpg`;
          }
          // Otherwise use fallback image (will be scaled by CSS)
          else if (fallbackImageUrl) {
            thumbnailUrl = fallbackImageUrl;
          }

          if (thumbnailUrl) {
            const img = document.createElement('img');
            img.src = thumbnailUrl;
            img.alt = item.closest('.story-card').querySelector('h3').textContent;
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'cover';

            const placeholder = item.querySelector('.manifest-thumbnail-placeholder');
            if (placeholder) {
              placeholder.replaceWith(img);
            }
          } else {
            throw new Error('No image found in manifest');
          }
        })
        .catch(error => {
          console.error('Error loading remote IIIF manifest:', objectData.iiif_manifest, error);
          const placeholder = item.querySelector('.manifest-thumbnail-placeholder');
          if (placeholder) {
            placeholder.innerHTML = '<span class="text-danger">Failed to load</span>';
          }
        });
    } else {
      // Local IIIF info.json
      fetch(localInfoUrl)
        .then(response => response.json())
        .then(info => {
          const sizes = info.sizes || [];
          let thumbnailSize = sizes[0];

          if (thumbnailSize) {
            const baseUrl = info.id || info['@id'];
            const thumbnailUrl = `${baseUrl}/full/${thumbnailSize.width},/0/default.jpg`;

            const img = document.createElement('img');
            img.src = thumbnailUrl;
            img.alt = item.closest('.story-card').querySelector('h3').textContent;
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'cover';

            const placeholder = item.querySelector('.manifest-thumbnail-placeholder');
            if (placeholder) {
              placeholder.replaceWith(img);
            }
          }
        })
        .catch(error => {
          console.error('Error loading local IIIF info.json:', localInfoUrl, error);
          const placeholder = item.querySelector('.manifest-thumbnail-placeholder');
          if (placeholder) {
            placeholder.innerHTML = '<span class="text-danger">Failed to load</span>';
          }
        });
    }
  });
});
</script>
