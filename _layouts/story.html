<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% if page.title %}{{ page.title }} | {% endif %}{{ site.title }}</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Source+Sans+Pro:wght@300;400;600&display=swap" rel="stylesheet">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="{{ '/assets/css/telar.css' | relative_url }}">

  {% seo %}
</head>
<body class="story-page">
  <div class="story-container">
    <!-- Left Column: Card Stacking Narrative -->
    <div class="narrative-column">
      <!-- Story Steps (including intro as step 0) -->
      <div class="story-steps">
        <!-- Intro Step - Full screen title card -->
        <div class="story-step story-intro" data-step="0" data-step-index="0">
          <div class="intro-content">
            <h1 class="intro-title">{{ page.story_number }}. {{ page.title }}</h1>
            {% if page.description %}
            <p class="intro-description">{{ page.description }}</p>
            {% endif %}
            <div class="intro-hint">
              <p class="text-muted">
                <small>Press ↓ or scroll to begin</small>
              </p>
            </div>
          </div>
          <a href="{{ '/' | relative_url }}" class="btn-home">
            ← Back to Home
          </a>
        </div>
        {% if page.data_file %}
          {% assign data_file_name = page.data_file %}
          {% assign steps = site.data[data_file_name] %}
          {% for step in steps %}
            {% include story-step.html
              step_number=step.step
              question=step.question
              answer=step.answer
              object_id=step.object
              x=step.x
              y=step.y
              zoom=step.zoom
              layer1button=step.layer1_button
              layer1_title=step.layer1_title
              layer1_text=step.layer1_text
              layer2button=step.layer2_button
              layer2_title=step.layer2_title
              layer2_text=step.layer2_text
              is_last=forloop.last
            %}
          {% endfor %}
        {% else %}
          {{ content }}
        {% endif %}
      </div>

      <!-- Story Navigation -->
      <div class="story-navigation mt-5 pt-4 border-top">
        <div class="row">
          {% if page.previous_story %}
          <div class="col-6">
            <a href="{{ page.previous_story | relative_url }}" class="btn btn-outline-primary">
              ← Previous Story
            </a>
          </div>
          {% endif %}

          <div class="col-6 text-end">
            {% if page.next_story %}
            <a href="{{ page.next_story | relative_url }}" class="btn btn-primary">
              Next Story →
            </a>
            {% else %}
            <a href="{{ '/' | relative_url }}" class="btn btn-outline-primary">
              Return Home
            </a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column: Fixed IIIF Viewer -->
    <div class="viewer-column">
      {% include viewer.html %}
    </div>
  </div>

  <!-- Panels -->
  {% include panels.html %}

  <!-- Bootstrap 5 JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- UniversalViewer IIIF Viewer -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/universalviewer@4.0.0/dist/uv.css">
  <script src="https://cdn.jsdelivr.net/npm/universalviewer@4.0.0/dist/umd/UV.js"></script>

  <!-- Scrollama -->
  <script src="{{ '/assets/js/scrollama.min.js' | relative_url }}"></script>

  <!-- Telar Core -->
  <script src="{{ '/assets/js/telar.js' | relative_url }}"></script>

  <!-- Story-specific JavaScript -->
  <script>
    // Pass story data to JavaScript
    {% if page.data_file %}
    // Load steps from data file
    {% assign data_file_name = page.data_file %}
    {% assign steps_data = site.data[data_file_name] %}
    window.storyData = {
      steps: {{ steps_data | jsonify }},
      firstObject: "{{ steps_data[0].object }}"
    };
    {% else %}
    window.storyData = {
      steps: {{ page.steps | jsonify }},
      firstObject: "{{ page.first_object }}"
    };
    {% endif %}

    // Pass objects data for manifest lookup
    window.objectsData = {{ site.data.objects | jsonify }};
  </script>
  <script src="{{ '/assets/js/story.js' | relative_url }}"></script>
</body>
</html>
