<!--
  Layered Panel System
  Panels are dynamically populated from chapter data
-->

<!-- Layer 1 Panel (Primary - Full-width offcanvas) -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="panel-layer1" data-bs-backdrop="false">
  <div class="offcanvas-header">
    <button type="button" class="btn btn-sm btn-outline-secondary" id="panel-layer1-back">
      ← Back
    </button>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="px-3">
    <h5 class="offcanvas-title" id="panel-layer1-title">Panel Title</h5>
  </div>
  <div class="offcanvas-body">
    <div id="panel-layer1-content">
      <!-- Content populated by JavaScript -->
    </div>
  </div>
</div>

<!-- Layer 2 Panel (Secondary - Stacked on top of Layer 1) -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="panel-layer2" data-bs-backdrop="false">
  <div class="offcanvas-header">
    <button type="button" class="btn btn-sm btn-outline-secondary" id="panel-layer2-back">
      ← Back
    </button>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="px-3">
    <h5 class="offcanvas-title" id="panel-layer2-title">Panel Title</h5>
  </div>
  <div class="offcanvas-body">
    <div id="panel-layer2-content">
      <!-- Content populated by JavaScript -->
    </div>
  </div>
</div>

<!-- Glossary Panel (Can appear from anywhere) -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="panel-glossary" data-bs-backdrop="false">
  <div class="offcanvas-header">
    <button type="button" class="btn btn-sm btn-outline-secondary" id="panel-glossary-back">
      ← Back
    </button>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="px-3">
    <h5 class="offcanvas-title" id="panel-glossary-title">Glossary Term</h5>
  </div>
  <div class="offcanvas-body">
    <div id="panel-glossary-content">
      <!-- Content populated by JavaScript -->
    </div>
  </div>
</div>

<style>
  /* Panel stacking - ensure proper z-index */
  .offcanvas {
    z-index: 1050;
  }

  #panel-layer2 {
    z-index: 1060;
  }

  #panel-glossary {
    z-index: 1070;
  }

  /* Panel content styling */
  .offcanvas-body img {
    max-width: 300px;
    height: auto;
    border-radius: 4px;
    margin: 1rem 0;
  }

  .offcanvas-body p {
    line-height: 1.8;
    margin-bottom: 1rem;
  }

  /* Image error styling */
  .offcanvas-body .img-error {
    background-color: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 4px;
    padding: 1rem;
    margin: 1rem 0;
    color: #856404;
  }

  .offcanvas-body .img-error code {
    background-color: #ffe69c;
    padding: 0.2em 0.4em;
    border-radius: 3px;
    font-size: 0.875em;
  }
</style>

<script>
  // Handle image loading errors in panels
  document.addEventListener('DOMContentLoaded', function() {
    // Add error handlers to existing images
    document.querySelectorAll('.offcanvas-body img').forEach(function(img) {
      img.addEventListener('error', function() {
        handleImageError(this);
      });
    });

    // Watch for new images added dynamically
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        mutation.addedNodes.forEach(function(node) {
          if (node.tagName === 'IMG') {
            node.addEventListener('error', function() {
              handleImageError(this);
            });
          } else if (node.querySelectorAll) {
            node.querySelectorAll('img').forEach(function(img) {
              img.addEventListener('error', function() {
                handleImageError(this);
              });
            });
          }
        });
      });
    });

    // Observe all panel bodies for image additions
    document.querySelectorAll('.offcanvas-body').forEach(function(body) {
      observer.observe(body, { childList: true, subtree: true });
    });
  });

  function handleImageError(img) {
    // Only process once
    if (img.dataset.errorHandled) return;
    img.dataset.errorHandled = 'true';

    const src = img.getAttribute('src') || '';
    const errorDiv = document.createElement('div');
    errorDiv.className = 'img-error';
    errorDiv.innerHTML = '<strong>Image file not found:</strong> <code>' + src + '</code><br>' +
                         'Please add this file or update the path in the markdown.';

    // Replace image with error message
    img.parentNode.replaceChild(errorDiv, img);
  }
</script>
